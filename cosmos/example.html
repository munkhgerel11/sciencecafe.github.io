<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Academy | Master Financial Command</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #050510;
            --panel: #101025;
            --panel-light: #1a1a35;
            --primary: #00f2ff;
            --secondary: #7000ff;
            --success: #00ff9d;
            --danger: #ff4757;
            --text: #e0e0e0;
            --text-muted: #7f8c8d;
            --border: #2c2c3a;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 50px; }

        /* HEADER */
        header { 
            background: linear-gradient(90deg, #0b0b1a 0%, #1a1a35 100%);
            padding: 20px 40px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); letter-spacing: 2px; text-transform: uppercase; }
        .logo i { margin-right: 10px; color: var(--secondary); }
        .btn { padding: 8px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; transition: 0.3s; margin-left: 10px; }
        .btn-save { background: var(--primary); color: #000; }
        .btn-save:hover { box-shadow: 0 0 15px var(--primary); }
        .btn-reset { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-reset:hover { background: var(--danger); color: white; }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        /* KPI BAR */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .kpi-title { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
        .kpi-val { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: white; }
        .kpi-sub { font-size: 0.75rem; margin-top: 5px; color: var(--text-muted); }

        /* TABS */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab { 
            padding: 12px 25px; background: transparent; color: var(--text-muted); 
            border: 1px solid transparent; cursor: pointer; font-size: 1rem; border-radius: 5px 5px 0 0;
            transition: 0.3s;
        }
        .tab:hover { color: var(--primary); }
        .tab.active { background: var(--panel); color: var(--primary); border: 1px solid var(--border); border-bottom: 1px solid var(--panel); font-weight: bold; }

        /* SECTIONS */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* TABLES */
        .table-container { background: var(--panel); border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(255,255,255,0.05); color: var(--primary); padding: 15px; text-align: left; font-size: 0.9rem; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover td { background: rgba(255,255,255,0.02); }
        
        input.cell-input { background: transparent; border: none; color: white; width: 100%; font-size: 1rem; padding: 5px; outline: none; }
        input.cell-input:focus { background: rgba(0, 242, 255, 0.1); border-radius: 4px; }
        
        .action-icon { color: var(--danger); cursor: pointer; opacity: 0.7; }
        .action-icon:hover { opacity: 1; }
        
        .add-row-btn { width: 100%; padding: 15px; background: rgba(255,255,255,0.02); color: var(--text-muted); border: none; cursor: pointer; transition: 0.2s; }
        .add-row-btn:hover { background: rgba(255,255,255,0.05); color: white; }

        /* FORM CONTROLS (Tab 3) */
        .config-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
        .config-panel { background: var(--panel); padding: 25px; border-radius: 10px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        .slider-val { color: var(--primary); font-weight: bold; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        .input-money { background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 5px; width: 100%; font-size: 1rem; }

        /* CHARTS (Tab 4) */
        .chart-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--border); height: 400px; position: relative; }

        /* UTILS */
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; background: rgba(255,255,255,0.1); }
        .b-renovation { color: #ff9ff3; background: rgba(255, 159, 243, 0.1); }
        .b-equipment { color: #54a0ff; background: rgba(84, 160, 255, 0.1); }

    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-atom"></i> Cosmos Planner <span style="font-size:0.8rem; opacity:0.5; margin-left:10px;">PRO VERSION</span></div>
        <div>
            <button class="btn btn-save" onclick="saveData()"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-reset" onclick="resetData()"><i class="fas fa-trash"></i> Reset</button>
        </div>
    </header>

    <div class="container">
        
        <!-- KPI TOP BAR -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Required Investment</div>
                <div class="kpi-val" id="kpi-capex">0 ₮</div>
                <div class="kpi-sub">Total Startup Cost</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Monthly Fixed Burn</div>
                <div class="kpi-val text-danger" id="kpi-opex">0 ₮</div>
                <div class="kpi-sub">Rent + Salaries</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Full ROI Date</div>
                <div class="kpi-val text-success" id="kpi-roi">---</div>
                <div class="kpi-sub">Investment Repaid</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Month 24 Net Profit</div>
                <div class="kpi-val text-primary" id="kpi-profit">0 ₮</div>
                <div class="kpi-sub">Projected Monthly</div>
            </div>
        </div>

        <!-- TABS -->
        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('capex')">1. Detailed CAPEX</button>
            <button class="tab" onclick="switchTab('opex')">2. Fixed OPEX</button>
            <button class="tab" onclick="switchTab('config')">3. Growth & Margins</button>
            <button class="tab" onclick="switchTab('charts')">4. Investor Projections</button>
        </div>

        <!-- TAB 1: CAPEX -->
        <div id="capex" class="section active">
            <div class="table-container">
                <table id="capex-table">
                    <thead>
                        <tr>
                            <th width="20%">Category</th>
                            <th width="40%">Item</th>
                            <th width="10%">Qty</th>
                            <th width="15%">Unit Cost (₮)</th>
                            <th width="15%">Total</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="capex-body"></tbody>
                </table>
                <button class="add-row-btn" onclick="addCapexRow()">+ Add Spending Item</button>
            </div>
        </div>

        <!-- TAB 2: OPEX -->
        <div id="opex" class="section">
            <div class="table-container">
                <table id="opex-table">
                    <thead>
                        <tr>
                            <th width="30%">Category</th>
                            <th width="40%">Description</th>
                            <th width="20%">Monthly Cost (₮)</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="opex-body"></tbody>
                </table>
                <button class="add-row-btn" onclick="addOpexRow()">+ Add Monthly Fixed Cost</button>
            </div>
            <p style="margin-top:10px; color:var(--text-muted); font-size:0.9rem;">* Note: Do not include Consumables here. Define "Variable Cost per Student" in Tab 3.</p>
        </div>

        <!-- TAB 3: CONFIG -->
        <div id="config" class="section">
            <div class="config-grid">
                
                <!-- Unit Economics -->
                <div class="config-panel">
                    <h3 class="text-primary"><i class="fas fa-tag"></i> Unit Economics</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Monthly Tuition Fee (₮)</label>
                        <input type="number" class="input-money" id="conf-tuition" oninput="updateAll()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Variable Cost per Student (Materials/Chemicals)</label>
                        <input type="number" class="input-money" id="conf-varcost" oninput="updateAll()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Science Box: Selling Price</label>
                        <input type="number" class="input-money" id="conf-boxprice" oninput="updateAll()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Science Box: Manufacturing Cost</label>
                        <input type="number" class="input-money" id="conf-boxcost" oninput="updateAll()">
                    </div>
                </div>

                <!-- Growth Strategy -->
                <div class="config-panel">
                    <h3 class="text-secondary"><i class="fas fa-chart-line"></i> Growth Strategy</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Starting Students (Month 1) <span class="slider-val" id="val-start">0</span></label>
                        <input type="range" id="slide-start" min="10" max="100" step="5" oninput="updateAll()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Students per Month <span class="slider-val" id="val-growth">0</span></label>
                        <input type="range" id="slide-growth" min="0" max="20" step="1" oninput="updateAll()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Box Sales per Month <span class="slider-val" id="val-boxes">0</span></label>
                        <input type="range" id="slide-boxes" min="0" max="200" step="5" oninput="updateAll()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Year 2 Inflation (Salaries/Rent Increase) <span class="slider-val" id="val-inf">0%</span></label>
                        <input type="range" id="slide-inf" min="0" max="20" step="1" oninput="updateAll()">
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: CHARTS -->
        <div id="charts" class="section">
            <div class="chart-row">
                <div class="chart-box">
                    <canvas id="cashflowChart"></canvas> <!-- Valley of Death -->
                </div>
                <div class="chart-box">
                    <canvas id="opsChart"></canvas> <!-- Ops Bar -->
                </div>
            </div>
            
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Students</th>
                            <th>Revenue</th>
                            <th>Expense</th>
                            <th>Net Profit</th>
                            <th>Bank Balance</th>
                        </tr>
                    </thead>
                    <tbody id="proj-body"></tbody>
                </table>
            </div>
        </div>

    </div>

<script>
    // --- DEFAULT DATA ---
    const defaultData = {
        capex: [
            { cat: 'Renovation', item: 'Futuristic Drywall & Lighting', qty: 1, cost: 50000000 },
            { cat: 'Renovation', item: 'Ventilation & HVAC', qty: 1, cost: 15000000 },
            { cat: 'Equipment', item: 'Lab Tables (China Import)', qty: 20, cost: 650000 },
            { cat: 'Equipment', item: 'Microscopes & Tools', qty: 20, cost: 850000 },
            { cat: 'Inventory', item: 'Initial Science Box Parts', qty: 500, cost: 40000 },
            { cat: 'Tech', item: 'Laptops & 3D Printers', qty: 15, cost: 2000000 }
        ],
        opex: [
            { cat: 'Rent', desc: '150m2 Location', cost: 6000000 },
            { cat: 'Salaries', desc: 'Teachers & Staff', cost: 10000000 },
            { cat: 'Utilities', desc: 'Internet, Elec, Heating', cost: 800000 },
            { cat: 'Marketing', desc: 'Social Ads', cost: 1000000 }
        ],
        config: {
            tuition: 450000,
            varCost: 25000,
            boxPrice: 80000,
            boxCost: 48000,
            startStudents: 40,
            growthRate: 5,
            boxSales: 50,
            inflation: 10
        }
    };

    let appData = JSON.parse(localStorage.getItem('cosmosMaster')) || JSON.parse(JSON.stringify(defaultData));

    // --- INIT ---
    let chart1, chart2;
    window.onload = function() {
        renderCapex();
        renderOpex();
        renderConfigInputs();
        updateAll();
    };

    // --- TAB LOGIC ---
    function switchTab(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'charts') updateCharts(); // Refresh charts to fix size issues
    }

    // --- CAPEX FUNCTIONS ---
    function renderCapex() {
        const tbody = document.getElementById('capex-body');
        tbody.innerHTML = '';
        appData.capex.forEach((row, i) => {
            let total = row.qty * row.cost;
            let tr = `<tr>
                <td><input class="cell-input badge b-renovation" value="${row.cat}" onchange="updateCapex(${i}, 'cat', this.value)"></td>
                <td><input class="cell-input" value="${row.item}" onchange="updateCapex(${i}, 'item', this.value)"></td>
                <td><input type="number" class="cell-input" value="${row.qty}" onchange="updateCapex(${i}, 'qty', this.value)"></td>
                <td><input type="number" class="cell-input" value="${row.cost}" onchange="updateCapex(${i}, 'cost', this.value)"></td>
                <td style="font-weight:bold;">${formatMoney(total)}</td>
                <td class="text-danger"><i class="fas fa-trash action-icon" onclick="delCapex(${i})"></i></td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }
    function updateCapex(i, field, val) { appData.capex[i][field] = field === 'qty' || field === 'cost' ? Number(val) : val; updateAll(); }
    function delCapex(i) { appData.capex.splice(i, 1); renderCapex(); updateAll(); }
    function addCapexRow() { appData.capex.push({ cat: 'New', item: 'Description', qty: 1, cost: 0 }); renderCapex(); }

    // --- OPEX FUNCTIONS ---
    function renderOpex() {
        const tbody = document.getElementById('opex-body');
        tbody.innerHTML = '';
        appData.opex.forEach((row, i) => {
            let tr = `<tr>
                <td><input class="cell-input badge b-equipment" value="${row.cat}" onchange="updateOpex(${i}, 'cat', this.value)"></td>
                <td><input class="cell-input" value="${row.desc}" onchange="updateOpex(${i}, 'desc', this.value)"></td>
                <td><input type="number" class="cell-input" value="${row.cost}" onchange="updateOpex(${i}, 'cost', this.value)"></td>
                <td class="text-danger"><i class="fas fa-trash action-icon" onclick="delOpex(${i})"></i></td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }
    function updateOpex(i, field, val) { appData.opex[i][field] = field === 'cost' ? Number(val) : val; updateAll(); }
    function delOpex(i) { appData.opex.splice(i, 1); renderOpex(); updateAll(); }
    function addOpexRow() { appData.opex.push({ cat: 'General', desc: 'Expense Name', cost: 0 }); renderOpex(); }

    // --- CONFIG FUNCTIONS ---
    function renderConfigInputs() {
        document.getElementById('conf-tuition').value = appData.config.tuition;
        document.getElementById('conf-varcost').value = appData.config.varCost;
        document.getElementById('conf-boxprice').value = appData.config.boxPrice;
        document.getElementById('conf-boxcost').value = appData.config.boxCost;
        
        document.getElementById('slide-start').value = appData.config.startStudents;
        document.getElementById('slide-growth').value = appData.config.growthRate;
        document.getElementById('slide-boxes').value = appData.config.boxSales;
        document.getElementById('slide-inf').value = appData.config.inflation;

        updateSliderLabels();
    }

    function updateSliderLabels() {
        document.getElementById('val-start').innerText = document.getElementById('slide-start').value;
        document.getElementById('val-growth').innerText = document.getElementById('slide-growth').value;
        document.getElementById('val-boxes').innerText = document.getElementById('slide-boxes').value;
        document.getElementById('val-inf').innerText = document.getElementById('slide-inf').value + '%';
    }

    // --- MASTER UPDATE LOGIC ---
    function updateAll() {
        // 1. Sync Inputs to State
        appData.config.tuition = Number(document.getElementById('conf-tuition').value);
        appData.config.varCost = Number(document.getElementById('conf-varcost').value);
        appData.config.boxPrice = Number(document.getElementById('conf-boxprice').value);
        appData.config.boxCost = Number(document.getElementById('conf-boxcost').value);
        appData.config.startStudents = Number(document.getElementById('slide-start').value);
        appData.config.growthRate = Number(document.getElementById('slide-growth').value);
        appData.config.boxSales = Number(document.getElementById('slide-boxes').value);
        appData.config.inflation = Number(document.getElementById('slide-inf').value);
        updateSliderLabels();

        // 2. Calculate Aggregates
        let totalCapex = appData.capex.reduce((sum, item) => sum + (item.qty * item.cost), 0);
        let monthlyFixed = appData.opex.reduce((sum, item) => sum + item.cost, 0);

        // 3. Update KPI Header
        document.getElementById('kpi-capex').innerText = formatCompact(totalCapex);
        document.getElementById('kpi-opex').innerText = formatCompact(monthlyFixed);

        // 4. Run Projection Loop
        let proj = runProjection(totalCapex, monthlyFixed);
        
        // 5. Update Remaining KPIs
        document.getElementById('kpi-profit').innerText = formatCompact(proj.profits[23]);
        document.getElementById('kpi-roi').innerText = proj.roiMonth > -1 ? `Month ${proj.roiMonth}` : 'Not in 2 yrs';

        // 6. Update Proj Table
        renderProjTable(proj);

        // 7. Update Charts
        renderCharts(proj);
    }

    function runProjection(totalCapex, fixedOpex) {
        let months = [], revenues = [], expenses = [], profits = [], cash = [];
        let currentCash = -totalCapex;
        let students = appData.config.startStudents;
        let roiMonth = -1;
        const maxCap = 140; // Max capacity 150m2

        for(let m=1; m<=24; m++) {
            // Growth
            if(m > 1) students += appData.config.growthRate;
            if(students > maxCap) students = maxCap;
            
            // Revenue
            let revTuition = Math.floor(students) * appData.config.tuition;
            let revBoxes = appData.config.boxSales * appData.config.boxPrice;
            let totalRev = revTuition + revBoxes;

            // Expenses
            let infMultiplier = (m >= 13) ? (1 + (appData.config.inflation/100)) : 1;
            let expFixed = fixedOpex * infMultiplier;
            let expVar = (Math.floor(students) * appData.config.varCost) + (appData.config.boxSales * appData.config.boxCost);
            let totalExp = expFixed + expVar;

            // Result
            let net = totalRev - totalExp;
            currentCash += net;

            if(roiMonth === -1 && currentCash >= 0) roiMonth = m;

            months.push(`M${m}`);
            revenues.push(totalRev);
            expenses.push(totalExp);
            profits.push(net);
            cash.push(currentCash);
        }

        return { months, revenues, expenses, profits, cash, roiMonth, students }; // Returning last student count isn't enough, but ok for now
    }

    function renderProjTable(data) {
        let tbody = document.getElementById('proj-body');
        tbody.innerHTML = '';
        // Show first 12 months only in table to save space
        for(let i=0; i<12; i++) {
            let row = `<tr>
                <td>${data.months[i]}</td>
                <td>${Math.round(data.students - ((11-i)*appData.config.growthRate))}</td> <!-- rough approx for display -->
                <td class="text-success">${formatCompact(data.revenues[i])}</td>
                <td class="text-danger">${formatCompact(data.expenses[i])}</td>
                <td style="font-weight:bold">${formatCompact(data.profits[i])}</td>
                <td style="color:${data.cash[i] >= 0 ? '#00ff9d':'#e0e0e0'}">${formatCompact(data.cash[i])}</td>
            </tr>`;
            tbody.innerHTML += row;
        }
    }

    function renderCharts(data) {
        if(chart1) chart1.destroy();
        if(chart2) chart2.destroy();

        // Chart 1: Cash Flow (Valley of Death)
        const ctx1 = document.getElementById('cashflowChart').getContext('2d');
        let gradient = ctx1.createLinearGradient(0,0,0,400);
        gradient.addColorStop(0, 'rgba(112, 0, 255, 0.4)');
        gradient.addColorStop(1, 'rgba(112, 0, 255, 0)');

        chart1 = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [{
                    label: 'Cumulative Cash (ROI)',
                    data: data.cash,
                    borderColor: '#7000ff',
                    backgroundColor: gradient,
                    fill: true,
                    borderWidth: 3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Investment Recovery Curve (Valley of Death)', color: 'white' },
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { color: '#333' } },
                    y: { grid: { color: '#333' }, ticks: { callback: (val) => formatCompact(val) } }
                }
            }
        });

        // Chart 2: Operations
        const ctx2 = document.getElementById('opsChart').getContext('2d');
        chart2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [
                    { label: 'Revenue', data: data.revenues, backgroundColor: '#00ff9d' },
                    { label: 'Expenses', data: data.expenses, backgroundColor: '#ff4757' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Monthly In vs Out', color: 'white' },
                    legend: { position: 'bottom', labels: { color: '#aaa' } }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { color: '#333' }, ticks: { callback: (val) => formatCompact(val) } }
                }
            }
        });
    }

    // --- UTILS ---
    function formatMoney(n) { return new Intl.NumberFormat('mn-MN').format(n); }
    function formatCompact(n) { return new Intl.NumberFormat('mn-MN', { notation: "compact" }).format(n) + '₮'; }
    function saveData() { localStorage.setItem('cosmosMaster', JSON.stringify(appData)); alert('Plan Saved!'); }
    function resetData() { if(confirm('Reset all data?')) { appData = JSON.parse(JSON.stringify(defaultData)); localStorage.removeItem('cosmosMaster'); location.reload(); } }

</script>

</body>
</html>